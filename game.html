<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی جاسوس</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #f9d71c;
            text-shadow: 0 0 10px rgba(249, 215, 28, 0.7);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
        }
        
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 10px rgba(249, 215, 28, 0.5);
        }
        
        button {
            background: linear-gradient(45deg, #f9d71c, #e94b3c);
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(249, 215, 28, 0.4);
        }
        
        button:disabled {
            background: #555;
            color: #aaa;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .secondary-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 8px 20px;
            font-size: 14px;
        }
        
        .role-display {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 2px solid #f9d71c;
        }
        
        .role-button {
            background: linear-gradient(45deg, #4e54c8, #8f94fb);
            padding: 15px 30px;
            font-size: 18px;
            margin: 20px auto;
            display: block;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .role-text {
            font-size: 24px;
            font-weight: bold;
            margin: 15px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
        }
        
        .players-list {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .player-item {
            padding: 8px 15px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .chat-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .message {
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            max-width: 80%;
        }
        
        .message.own {
            background: rgba(76, 175, 80, 0.3);
            margin-right: auto;
            margin-left: 20%;
        }
        
        .message.other {
            background: rgba(33, 150, 243, 0.3);
            margin-left: auto;
            margin-right: 20%;
        }
        
        .message-info {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
        }
        
        .poll-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .poll-option {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .poll-bar {
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            flex: 1;
            margin: 0 10px;
        }
        
        .poll-fill {
            height: 100%;
            background: linear-gradient(45deg, #f9d71c, #e94b3c);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }
        
        .poll-percent {
            min-width: 50px;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
        
        .timer {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0;
            color: #f9d71c;
        }
        
        .status-message {
            text-align: center;
            padding: 15px;
            background: rgba(249, 215, 28, 0.2);
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .team-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .team-spy {
            background: #e94b3c;
            color: #fff;
        }
        
        .team-citizen {
            background: #4caf50;
            color: #fff;
        }
        
        .poll-creation {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .poll-options-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .poll-option-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .poll-option-item input {
            margin-left: 10px;
        }
        
        .chat-disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .admin-panel {
            background: rgba(249, 215, 28, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            border: 2px dashed #f9d71c;
        }
        
        .admin-panel h3 {
            text-align: center;
            color: #f9d71c;
            margin-top: 0;
        }
        
        .admin-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .admin-controls button {
            background: linear-gradient(45deg, #f9d71c, #e94b3c);
        }
        
        .game-info {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .game-info-item {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .game-info-label {
            font-weight: bold;
        }
        
        .game-info-value {
            color: #f9d71c;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .input-group input {
            flex: 1;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .change-name-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            font-size: 14px;
            padding: 8px 15px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: rgba(244, 67, 54, 0.9);
        }
        
        .lobby-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .current-user {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .current-user-name {
            font-size: 18px;
            font-weight: bold;
            color: #f9d71c;
        }
        
        .spy-list {
            margin-top: 10px;
            font-size: 16px;
            color: #e94b3c;
        }
        
        /* استایل‌های دکمه‌های نظرسنجی */
        .poll-vote-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
            text-align: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .poll-vote-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        .poll-vote-btn:disabled {
            background: #555;
            color: #aaa;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .poll-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .poll-status {
            text-align: center;
            padding: 10px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 8px;
            margin-top: 15px;
            font-weight: bold;
        }
        
        /* استایل‌های موبایل */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .role-button {
                padding: 12px 25px;
                font-size: 16px;
                margin: 15px auto;
            }
            
            .role-text {
                font-size: 18px;
                min-height: 80px;
            }
            
            .role-display {
                padding: 15px;
                margin: 20px 0;
            }
            
            .chat-container {
                height: 350px;
            }
            
            .poll-option {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .poll-bar {
                width: 100%;
                margin: 5px 0;
            }
            
            .poll-percent {
                width: 50px;
                text-align: left;
            }
            
            button {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .admin-controls button {
                padding: 10px 20px;
            }
            
            .poll-options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>بازی جاسوس</h1>
        
        <!-- فرم ورود نام -->
        <div id="name-form" class="form-group">
            <label for="player-name">نام خود را وارد کنید:</label>
            <input type="text" id="player-name" placeholder="نام شما">
            <button id="submit-name">ثبت نام</button>
        </div>
        
        <!-- پنل ادمین (فقط برای مهدی) -->
        <div id="admin-panel" class="admin-panel hidden">
            <h3>پنل مدیریت بازی</h3>
            <p>شما به عنوان مدیر بازی می‌توانید بازی را کنترل کنید</p>
            
            <div class="game-info">
                <div class="game-info-item">
                    <span class="game-info-label">تعداد بازیکنان:</span>
                    <span class="game-info-value" id="admin-player-count">0</span>
                </div>
                <div class="game-info-item">
                    <span class="game-info-label">وضعیت بازی:</span>
                    <span class="game-info-value" id="admin-game-status">شروع نشده</span>
                </div>
                <div class="game-info-item">
                    <span class="game-info-label">وضعیت چت:</span>
                    <span class="game-info-value" id="admin-chat-status">غیرفعال</span>
                </div>
            </div>
            
            <div class="admin-controls">
                <div class="input-group">
                    <label for="spy-count">تعداد جاسوس‌ها:</label>
                    <input type="number" id="spy-count" min="1" max="5" value="2">
                </div>
                <button id="start-game-btn">شروع بازی</button>
                <button id="start-chat-btn">فعال کردن چت</button>
                <button id="reset-game-btn">ریست بازی</button>
                <button id="new-game-btn" class="secondary-btn">شروع بازی جدید</button>
            </div>
        </div>
        
        <!-- نمایش وضعیت بازی -->
        <div id="game-status" class="status-message hidden">
            <p>بازی هنوز شروع نشده است. لطفا صبر کنید...</p>
            <div class="current-user">
                <div>نام شما:</div>
                <div class="current-user-name" id="current-user-name">-</div>
            </div>
            <div class="lobby-actions">
                <button id="change-name-in-status" class="change-name-btn secondary-btn">تغییر نام</button>
                <button id="refresh-btn" class="secondary-btn">به‌روزرسانی</button>
            </div>
        </div>
        
        <!-- لیست بازیکنان -->
        <div id="players-section" class="hidden">
            <div class="section-header">
                <h2>بازیکنان حاضر (<span id="player-count">0</span> نفر)</h2>
                <button id="change-name-btn" class="change-name-btn secondary-btn hidden">تغییر نام</button>
            </div>
            <div id="players-list" class="players-list"></div>
        </div>
        
        <!-- بخش نمایش نقش -->
        <div id="role-section" class="hidden">
            <div class="role-display">
                <p>برای دیدن نقش خود، دکمه زیر را نگه دارید</p>
                <button id="role-button" class="role-button">نمایش نقش</button>
                <div id="role-text" class="role-text"></div>
            </div>
        </div>
        
        <!-- تایمر چت -->
        <div id="timer" class="timer hidden"></div>
        
        <!-- بخش چت -->
        <div id="chat-section" class="hidden">
            <h2>چت تیمی</h2>
            <div id="chat-container" class="chat-container">
                <div id="chat-messages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" class="chat-input" placeholder="پیام خود را بنویسید...">
                    <button id="send-message">ارسال</button>
                </div>
            </div>
        </div>
        
        <!-- بخش نظرسنجی (برای همه بازیکنان) -->
        <div id="poll-section" class="hidden">
            <h2>نظرسنجی بازیکنان</h2>
            <div id="poll-container" class="poll-container">
                <h3>چه کسی جاسوس است؟</h3>
                <div id="poll-options-container"></div>
                <div id="poll-status" class="poll-status hidden">شما رأی خود را ثبت کرده‌اید</div>
            </div>
        </div>
    </div>
    <!-- اعلان‌ها -->
    <div id="notification" class="notification"></div>
    <script>
        // اطلاعات دیتابیس
        const DB_CONFIG = {
            nameAndCitizenChat: {
                binID: "68c7fe59ae596e708fef54ea",
                name: "ChatShahrvand&Name",
                XmasterKey: "$2a$10$H7UF6qZdQe40juGQT.7G3uVhMsxLaKVrmg0y1PbRQwHJQrQbBIbfm"
            },
            spyChat: {
                binID: "68c7fef143b1c97be9439901",
                name: "ChatJasoos",
                XmasterKey: "$2a$10$H7UF6qZdQe40juGQT.7G3uVhMsxLaKVrmg0y1PbRQwHJQrQbBIbfm"
            }
        };
        // متغیرهای جهانی
        let playerName = localStorage.getItem('playerName') || '';
        let playerRole = '';
        let chatStartTime = 0;
        let chatInterval;
        let timerInterval;
        let gameStateInterval;
        let pollInterval;
        let spiesList = [];
        let citizensList = [];
        let currentPoll = null;
        let hasVoted = false;
        let isAdmin = false;
        // وضعیت اولیه بازی
        let gameState = {
            gameStarted: false,
            chatStarted: false,
            numberOfSpies: 2,
            gameWord: ""
        };
        // دسته‌بندی‌های کلمات
        const wordCategories = {
            "اشیاء": ["کتاب", "خودکار", "لیوان", "صندلی", "میز", "موبایل", "لپ‌تاپ", "ساعت", "کیف", "کفش", "دوچرخه", "ماشین", "هواپیما", "قطار", "کشتی", "توپ فوتبال", "دوربین", "تلویزیون", "یخچال", "چراغ", "کلید", "قفل", "شمشیر", "تفنگ", "نقشه", "تلسکوپ", "میکروسکوپ", "گیتار", "پیانو", "ویولن", "ربات", "پهپاد", "پرچم", "چتر", "طناب", "قایق", "عینک", "کلاه", "شمع", "آینه", "زنگ", "چاقو", "چکش", "آچار", "پیچ‌گوشتی", "بیل", "سطل", "زنجیر", "ساعت شنی"],
            "جغرافیا": ["جزیره", "دانشگاه", "روستا", "بیمارستان", "پاریس", "کشور", "کلیسای واتیکان", "شهرکرد", "رستوران", "لندن", "دادگاه تجدید نظر", "شیراز", "کلانتری", "مدار صفر درجه", "جزیره متروکه", "تالار عروسی", "تئاتر", "تاج محل", "جشنواره", "مشهد", "حمام", "کوهستان", "درمانگاه", "پشت‌بام", "خیابان", "زندان", "آتشکده", "رادیولوژی", "اصفهان", "مجلس عروسی", "شهر", "دفتر ازدواج", "سینما", "هیمالیا", "آزمایشگاه", "مدرسه", "فروشگاه", "پاساژ", "تهران", "دماوند", "ده", "غار اصحاب کهف", "پالایشگاه", "استخر", "اورست", "ساندویچی", "شهربازی", "پارک", "قلعه", "ساری", "بندرعباس", "فرودگاه", "موزه", "کتابخانه", "هتل", "ساحل", "ایستگاه قطار", "باغ‌وحش", "پل", "میدان", "کارخانه", "گورستان", "مسجد", "معبد", "باشگاه ورزشی", "آبشار", "دانشکده", "سرداب", "برج", "پمپ‌بنزین", "بازار", "بیابان", "رصدخانه", "کافه", "ایستگاه مترو", "کویر", "برج میلاد", "باغ ملی", "کشتی", "کارخانه شکلات", "گلخانه", "کتابفروشی", "میدان آزادی", "کاروانسرا", "خانه قدیمی", "موزه جنگ"],
            "حیوانات": ["سگ", "گربه", "گوسفند", "گاو", "اسب", "مرغ", "خرگوش", "موش", "فیل", "شیر", "ببر", "پلنگ", "گرگ", "روباه", "خرس", "میمون", "گورکن", "جغد", "عقاب", "کبوتر", "قوش", "شاهین", "لاک‌پشت", "مار", "تمساح", "وزغ", "قورباغه", "ماهی", "نهنگ", "کوسه", "دلفین", "ختف", "پنگوئن", "کرگدن", "زرافه", "آهو", "غزال", "مورچه", "زنبور", "پروانه", "سوسک", "عنکبوت"],
            "خوردنی‌ها": ["نان", "برنج", "ماست", "پنیر", "کره", "خیار", "گوجه", "سیب", "پرتقال", "موز", "کیوی", "انار", "هندوانه", "خربزه", "توت", "تخم مرغ", "مرغ", "گوشت", "ماهی", "قورمه سبزی", "قیمه", "کباب", "پیتزا", "ساندویچ", "سالاد", "سوپ", "آب", "چای", "قهوه", "شیر", "آبمیوه", "ماکارونی", "لازانیا", "بستنی", "شکلات", "کیک", "شیرینی", "کوکو", "کوکو سبزی", "کلم پلو", "لوبیا پلو", "عدس پلو", "زیتون پرورده", "ترشی", "مربا", "عسل", "خرما"],
            "طبیعت": ["کوه", "دریا", "رودخانه", "جنگل", "بیابان", "دشت", "چمنزار", "آبشار", "غار", "چشمه", "برکه", "تالاب", "ساحل", "جزیره", "کوهستان", "دره", "تپه", "صحرا", "کویر", "یخچال طبیعی", "آتشفشان", "زمین لرزه", "طوفان", "باران", "برف", "تگرگ", "باد", "رعد و برق", "رنگین کمان", "مه", "شبنم", "یخ", "خورشید", "ماه", "ستاره", "کهکشان", "سیاره", "دنیا", "فضا", "آسمان", "ابر", "سایه", "نور", "تاریکی", "گرما", "سرما"],
            "عمومی": ["عشق", "دوست", "خانواده", "کودک", "بزرگسال", "پیرمرد", "پیرزن", "نوزاد", "نوجوان", "مرد", "زن", "پسر", "دختر", "معلم", "دانش‌آموز", "دانشجو", "پزشک", "پرستار", "مهندس", "وکیل", "قاضی", "سرباز", "پلیس", "آتش‌نشان", "راننده", "فروشنده", "کارگر", "کشاورز", "هنرمند", "نویسنده", "خواننده", "بازیگر", "ورزشکار", "آشپز", "خدمتکار", "مسافر", "توریست", "مهاجر", "پناهنده", "بی‌خانمان", "ثروتمند", "فقیر", "خسی", "بخیل", "سخاوتمند", "مهربان", "خشن", "آرام", "عصبانی", "شاد", "غمگین", "خنده", "گریه"],
            "مشاغل": ["بیکار", "مأمور", "دکتر", "جراح", "گارسون", "شیرفروش", "صاحب تالار", "معلم", "جادوگر", "کارمند گوگل", "مجری", "ماساژور", "سیاسی", "پلیس فتا", "مدیر منابع انسانی", "دادستان عمومی", "تشریفات", "زندانبان", "رفتگر", "ساندویچ‌فروش", "مانتوفروش", "نجار", "خلبان", "نقاش", "آهنگر", "مکانیک", "فوتبالیست", "راننده تاکسی", "خبرنگار", "شاعر", "بازیگر", "نویسنده", "نانوا", "آشپز", "برنامه‌نویس", "کشاورز", "دامدار", "شکارچی", "ماهیگیر", "فضانورد", "باستان‌شناس", "آهنگساز"]
        };
        // عناصر DOM
        const nameForm = document.getElementById('name-form');
        const playerNameInput = document.getElementById('player-name');
        const submitNameBtn = document.getElementById('submit-name');
        const adminPanel = document.getElementById('admin-panel');
        const adminPlayerCount = document.getElementById('admin-player-count');
        const adminGameStatus = document.getElementById('admin-game-status');
        const adminChatStatus = document.getElementById('admin-chat-status');
        const spyCountInput = document.getElementById('spy-count');
        const startGameBtn = document.getElementById('start-game-btn');
        const startChatBtn = document.getElementById('start-chat-btn');
        const resetGameBtn = document.getElementById('reset-game-btn');
        const newGameBtn = document.getElementById('new-game-btn');
        const gameStatus = document.getElementById('game-status');
        const currentUser = document.getElementById('current-user-name');
        const changeNameInStatus = document.getElementById('change-name-in-status');
        const refreshBtn = document.getElementById('refresh-btn');
        const playersSection = document.getElementById('players-section');
        const changeNameBtn = document.getElementById('change-name-btn');
        const playerCount = document.getElementById('player-count');
        const playersList = document.getElementById('players-list');
        const roleSection = document.getElementById('role-section');
        const roleButton = document.getElementById('role-button');
        const roleText = document.getElementById('role-text');
        const timer = document.getElementById('timer');
        const chatSection = document.getElementById('chat-section');
        const chatContainer = document.getElementById('chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendMessageBtn = document.getElementById('send-message');
        const pollSection = document.getElementById('poll-section');
        const pollContainer = document.getElementById('poll-container');
        const pollOptionsContainer = document.getElementById('poll-options-container');
        const pollStatus = document.getElementById('poll-status');
        const notification = document.getElementById('notification');
        // رویدادها
        submitNameBtn.addEventListener('click', submitName);
        changeNameBtn.addEventListener('click', changeName);
        changeNameInStatus.addEventListener('click', changeName);
        refreshBtn.addEventListener('click', refreshPage);
        startGameBtn.addEventListener('click', startGame);
        startChatBtn.addEventListener('click', startChat);
        resetGameBtn.addEventListener('click', resetGame);
        newGameBtn.addEventListener('click', startNewGame);
        roleButton.addEventListener('mousedown', showRole);
        roleButton.addEventListener('mouseup', hideRole);
        roleButton.addEventListener('mouseleave', hideRole);
        roleButton.addEventListener('touchstart', showRole);
        roleButton.addEventListener('touchend', hideRole);
        sendMessageBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        // تابع نمایش اعلان
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = `notification ${isError ? 'error' : ''} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        // تابع ثبت نام بازیکن
        async function submitName() {
            const name = playerNameInput.value.trim();
            if (!name) {
                showNotification('لطفا نام خود را وارد کنید', true);
                return;
            }
            playerName = name;
            localStorage.setItem('playerName', playerName);
            
            // بررسی آیا بازیکن ادمین است
            isAdmin = (playerName === 'مهدی');
            
            showNotification('نام شما با موفقیت ثبت شد');
            
            // ذخیره نام در دیتابیس
            const success = await savePlayerName(playerName);
            if (!success) {
                showNotification('خطا در ثبت نام در دیتابیس', true);
                return;
            }
            
            // به‌روزرسانی رابط کاربری
            nameForm.classList.add('hidden');
            playersSection.classList.remove('hidden');
            gameStatus.classList.remove('hidden');
            
            // نمایش نام کاربر فعلی
            currentUser.textContent = playerName;
            
            // نمایش پنل ادمین اگر مهدی باشد
            if (isAdmin) {
                adminPanel.classList.remove('hidden');
            }
            
            // بارگیری لیست بازیکنان
            await loadPlayers();
            
            // بارگیری وضعیت بازی
            await loadGameState();
            
            // شروع بررسی وضعیت بازی
            startGameStateCheck();
        }
        // تابع تغییر نام
        function changeName() {
            // فقط اگر بازی شروع نشده باشد
            if (gameState.gameStarted) {
                showNotification('بازی شروع شده است. امکان تغییر نام وجود ندارد', true);
                return;
            }
            
            // نمایش فرم نام
            nameForm.classList.remove('hidden');
            playersSection.classList.add('hidden');
            gameStatus.classList.add('hidden');
            adminPanel.classList.add('hidden');
            
            // پاک کردن نام قبلی
            playerNameInput.value = '';
            localStorage.removeItem('playerName');
            
            // حذف نام از دیتابیس
            removePlayerName(playerName);
        }
        // تابع به‌روزرسانی صفحه
        function refreshPage() {
            window.location.reload();
        }
        // تابع حذف نام بازیکن از دیتابیس
        async function removePlayerName(name) {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                let names = data.record?.data?.name || [];
                
                // حذف نام از لیست
                names = names.filter(n => n !== name);
                
                await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    },
                    body: JSON.stringify({
                        data: {
                            ...data.record.data,
                            name: names
                        }
                    })
                });
            } catch (error) {
                console.error('خطا در حذف نام:', error);
                showNotification('خطا در حذف نام از دیتابیس', true);
            }
        }
        // تابع ذخیره نام بازیکن در دیتابیس
        async function savePlayerName(name) {
            try {
                // ابتدا داده‌های فعلی را بخوان
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error('خطا در دریافت داده‌ها');
                }
                
                const data = await response.json();
                const currentData = data.record || { data: { name: [], ChatShahrvand: [], gameState: {} } };
                const names = currentData.data.name || [];
                
                // اضافه کردن نام جدید اگر وجود ندارد
                if (!names.includes(name)) {
                    names.push(name);
                    
                    // به‌روزرسانی داده‌ها
                    const updatedData = {
                        ...currentData,
                        data: {
                            ...currentData.data,
                            name: names
                        }
                    };
                    
                    // ذخیره داده‌های به‌روز شده
                    const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                        },
                        body: JSON.stringify(updatedData)
                    });
                    
                    if (!updateResponse.ok) {
                        throw new Error('خطا در به‌روزرسانی داده‌ها');
                    }
                }
                
                return true;
            } catch (error) {
                console.error('خطا در ذخیره نام:', error);
                return false;
            }
        }
        // تابع بارگیری لیست بازیکنان
        async function loadPlayers() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                const names = data.record?.data?.name || [];
                
                // به‌روزرسانی تعداد بازیکنان
                playerCount.textContent = names.length;
                if (isAdmin) {
                    adminPlayerCount.textContent = names.length;
                }
                
                // نمایش لیست بازیکنان بدون نشانگر نقش
                playersList.innerHTML = '';
                names.forEach(name => {
                    const playerItem = document.createElement('div');
                    playerItem.className = 'player-item';
                    playerItem.innerHTML = `<span>${name}</span>`;
                    playersList.appendChild(playerItem);
                });
            } catch (error) {
                console.error('خطا در بارگیری بازیکنان:', error);
                showNotification('خطا در بارگیری لیست بازیکنان', true);
            }
        }
        // تابع بارگیری وضعیت بازی
        async function loadGameState() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                const savedGameState = data.record?.data?.gameState;
                
                if (savedGameState) {
                    gameState = savedGameState;
                    
                    // به‌روزرسانی وضعیت در پنل ادمین
                    if (isAdmin) {
                        adminGameStatus.textContent = gameState.gameStarted ? 'شروع شده' : 'شروع نشده';
                        adminChatStatus.textContent = gameState.chatStarted ? 'فعال' : 'غیرفعال';
                        spyCountInput.value = gameState.numberOfSpies;
                    }
                    
                    // نمایش دکمه تغییر نام فقط اگر بازی شروع نشده باشد
                    if (!gameState.gameStarted) {
                        changeNameBtn.classList.remove('hidden');
                        changeNameInStatus.classList.remove('hidden');
                    } else {
                        changeNameBtn.classList.add('hidden');
                        changeNameInStatus.classList.add('hidden');
                    }
                    
                    // اگر بازی شروع شده، نقش‌ها را تخصیص بده
                    if (gameState.gameStarted) {
                        await loadRolesFromDatabase();
                        roleSection.classList.remove('hidden');
                        
                        // نمایش بخش نظرسنجی برای همه بازیکنان
                        pollSection.classList.remove('hidden');
                        
                        // اگر چت فعال شده، آن را شروع کن
                        if (gameState.chatStarted) {
                            startChatFromState();
                        } else {
                            // نمایش بخش چت (غیرفعال)
                            chatSection.classList.remove('hidden');
                            chatContainer.classList.add('chat-disabled');
                        }
                        
                        // بارگیری نظرسنجی
                        loadPoll();
                        
                        // شروع به‌روزرسانی نظرسنجی
                        startPollCheck();
                    } else {
                        gameStatus.classList.remove('hidden');
                        gameStatus.querySelector('p').textContent = 'بازی هنوز شروع نشده است. لطفا صبر کنید...';
                    }
                }
            } catch (error) {
                console.error('خطا در بارگیری وضعیت بازی:', error);
                showNotification('خطا در بارگیری وضعیت بازی', true);
            }
        }
        // تابع ذخیره وضعیت بازی
        async function saveGameState() {
            try {
                // ابتدا داده‌های فعلی را بخوان
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                const currentData = data.record || { data: { name: [], ChatShahrvand: [], gameState: {} } };
                
                // به‌روزرسانی وضعیت بازی
                const updatedData = {
                    ...currentData,
                    data: {
                        ...currentData.data,
                        gameState: gameState
                    }
                };
                
                // ذخیره داده‌های به‌روز شده
                await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    },
                    body: JSON.stringify(updatedData)
                });
            } catch (error) {
                console.error('خطا در ذخیره وضعیت بازی:', error);
                showNotification('خطا در ذخیره وضعیت بازی', true);
            }
        }
        // تابع شروع بررسی وضعیت بازی
        function startGameStateCheck() {
            gameStateInterval = setInterval(async () => {
                await loadGameState();
            }, 3000);
        }
        // تابع شروع بازی
        async function startGame() {
            if (!isAdmin) return;
            
            // دریافت تعداد جاسوس‌ها از input
            gameState.numberOfSpies = parseInt(spyCountInput.value);
            
            // انتخاب کلمه بازی به صورت رندوم
            const allWords = Object.values(wordCategories).flat();
            gameState.gameWord = allWords[Math.floor(Math.random() * allWords.length)];
            
            // به‌روزرسانی وضعیت بازی
            gameState.gameStarted = true;
            gameState.chatStarted = false;
            
            // ذخیره وضعیت بازی
            await saveGameState();
            
            // ایجاد نظرسنجی خودکار
            await createAutomaticPoll();
            
            // به‌روزرسانی UI
            adminGameStatus.textContent = 'شروع شده';
            adminChatStatus.textContent = 'غیرفعال';
            changeNameBtn.classList.add('hidden');
            changeNameInStatus.classList.add('hidden');
            
            showNotification('بازی با موفقیت شروع شد');
        }
        // تابع ایجاد نظرسنجی خودکار
        async function createAutomaticPoll() {
            try {
                // دریافت لیست بازیکنان
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                const allPlayers = data.record?.data?.name || [];
                
                // ایجاد نظرسنجی
                currentPoll = {
                    question: "چه کسی جاسوس است؟",
                    options: allPlayers,
                    votes: {}
                };
                
                // مقداردهی اولیه رأی‌ها
                allPlayers.forEach(player => {
                    currentPoll.votes[player] = 0;
                });
                
                // ذخیره نظرسنجی در دیتابیس
                await savePoll();
                
                showNotification('نظرسنجی با موفقیت ایجاد شد');
            } catch (error) {
                console.error('خطا در ایجاد نظرسنجی:', error);
                showNotification('خطا در ایجاد نظرسنجی', true);
            }
        }
        // تابع ذخیره نظرسنجی
        async function savePoll() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                const currentData = data.record || { data: { name: [], ChatShahrvand: [], gameState: {} } };
                
                // به‌روزرسانی داده‌ها با نظرسنجی
                const updatedData = {
                    ...currentData,
                    data: {
                        ...currentData.data,
                        poll: currentPoll
                    }
                };
                
                // ذخیره داده‌های به‌روز شده
                await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    },
                    body: JSON.stringify(updatedData)
                });
            } catch (error) {
                console.error('خطا در ذخیره نظرسنجی:', error);
                showNotification('خطا در ذخیره نظرسنجی', true);
            }
        }
        // تابع بارگیری نظرسنجی
        async function loadPoll() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                currentPoll = data.record?.data?.poll;
                
                if (currentPoll) {
                    displayPoll();
                }
            } catch (error) {
                console.error('خطا در بارگیری نظرسنجی:', error);
                showNotification('خطا در بارگیری نظرسنجی', true);
            }
        }
        // تابع شروع بررسی نظرسنجی
        function startPollCheck() {
            pollInterval = setInterval(async () => {
                await loadPoll();
            }, 3000);
        }
        // تابع نمایش نظرسنجی
        function displayPoll() {
            if (!currentPoll) return;
            
            pollOptionsContainer.innerHTML = '';
            
            // اگر کاربر رأی نداده، دکمه‌های رأی را نمایش بده
            if (!hasVoted) {
                const optionsGrid = document.createElement('div');
                optionsGrid.className = 'poll-options-grid';
                
                currentPoll.options.forEach(option => {
                    const voteBtn = document.createElement('button');
                    voteBtn.className = 'poll-vote-btn';
                    voteBtn.textContent = option;
                    voteBtn.dataset.player = option;
                    
                    voteBtn.addEventListener('click', async () => {
                        await voteForPlayer(option);
                    });
                    
                    optionsGrid.appendChild(voteBtn);
                });
                
                pollOptionsContainer.appendChild(optionsGrid);
                pollStatus.classList.add('hidden');
            } else {
                // نمایش نتایج نظرسنجی
                const totalVotes = Object.values(currentPoll.votes).reduce((sum, count) => sum + count, 0);
                
                currentPoll.options.forEach(option => {
                    const votes = currentPoll.votes[option];
                    const percentage = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'poll-option';
                    optionDiv.innerHTML = `
                        <div>${option}</div>
                        <div class="poll-bar">
                            <div class="poll-fill" style="width: ${percentage}%">${percentage}%</div>
                        </div>
                        <div class="poll-percent">${votes} رأی</div>
                    `;
                    pollOptionsContainer.appendChild(optionDiv);
                });
                
                pollStatus.classList.remove('hidden');
            }
        }
        // تابع رأی دادن به بازیکن
        async function voteForPlayer(playerName) {
            if (!currentPoll || hasVoted) return;
            
            try {
                // افزایش رأی برای بازیکن انتخاب شده
                currentPoll.votes[playerName]++;
                hasVoted = true;
                
                // ذخیره نظرسنجی به‌روز شده
                await savePoll();
                
                // به‌روزرسانی نمایش
                displayPoll();
                
                showNotification(`رأی شما به ${playerName} با موفقیت ثبت شد`);
            } catch (error) {
                console.error('خطا در ثبت رأی:', error);
                showNotification('خطا در ثبت رأی', true);
            }
        }
        // تابع شروع چت
        async function startChat() {
            if (!isAdmin) return;
            
            // به‌روزرسانی وضعیت چت
            gameState.chatStarted = true;
            
            // ذخیره وضعیت بازی
            await saveGameState();
            
            // به‌روزرسانی UI
            adminChatStatus.textContent = 'فعال';
            
            showNotification('چت با موفقیت فعال شد');
        }
        // تابع ریست بازی
        async function resetGame() {
            if (!isAdmin) return;
            
            // ریست وضعیت بازی
            gameState = {
                gameStarted: false,
                chatStarted: false,
                numberOfSpies: 2,
                gameWord: ""
            };
            
            // ذخیره وضعیت بازی
            await saveGameState();
            
            // به‌روزرسانی UI
            adminGameStatus.textContent = 'شروع نشده';
            adminChatStatus.textContent = 'غیرفعال';
            spyCountInput.value = 2;
            changeNameBtn.classList.remove('hidden');
            changeNameInStatus.classList.remove('hidden');
            
            // ریست متغیرهای محلی
            spiesList = [];
            citizensList = [];
            playerRole = '';
            currentPoll = null;
            hasVoted = false;
            
            // پنهان کردن بخش‌های بازی
            roleSection.classList.add('hidden');
            chatSection.classList.add('hidden');
            pollSection.classList.add('hidden');
            
            // نمایش پیام وضعیت
            gameStatus.classList.remove('hidden');
            gameStatus.querySelector('p').textContent = 'بازی هنوز شروع نشده است. لطفا صبر کنید...';
            
            showNotification('بازی با موفقیت ریست شد');
        }
        // تابع شروع بازی جدید
        async function startNewGame() {
            if (!isAdmin) return;
            
            // پاک کردن چت‌ها
            await clearChats();
            
            // پاک کردن نقش‌ها
            await clearRoles();
            
            // پاک کردن نظرسنجی
            await clearPoll();
            
            // ریست وضعیت بازی
            gameState = {
                gameStarted: false,
                chatStarted: false,
                numberOfSpies: 2,
                gameWord: ""
            };
            
            // ذخیره وضعیت بازی
            await saveGameState();
            
            // به‌روزرسانی UI
            adminGameStatus.textContent = 'شروع نشده';
            adminChatStatus.textContent = 'غیرفعال';
            spyCountInput.value = 2;
            changeNameBtn.classList.remove('hidden');
            changeNameInStatus.classList.remove('hidden');
            
            // ریست متغیرهای محلی
            spiesList = [];
            citizensList = [];
            playerRole = '';
            currentPoll = null;
            hasVoted = false;
            
            // پنهان کردن بخش‌های بازی
            roleSection.classList.add('hidden');
            chatSection.classList.add('hidden');
            pollSection.classList.add('hidden');
            
            // نمایش پیام وضعیت
            gameStatus.classList.remove('hidden');
            gameStatus.querySelector('p').textContent = 'بازی جدید آماده است. منتظر بازیکنان باشید...';
            
            showNotification('بازی جدید با موفقیت آماده شد');
        }
        // تابع پاک کردن چت‌ها
        async function clearChats() {
            try {
                // پاک کردن چت جاسوس‌ها
                await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.spyChat.binID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': DB_CONFIG.spyChat.XmasterKey
                    },
                    body: JSON.stringify({
                        data: {
                            ChatJasoos: []
                        }
                    })
                });
                
                // پاک کردن چت شهروندان
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                const currentData = data.record || { data: { name: [], ChatShahrvand: [], gameState: {} } };
                
                await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    },
                    body: JSON.stringify({
                        data: {
                            ...currentData.data,
                            ChatShahrvand: []
                        }
                    })
                });
            } catch (error) {
                console.error('خطا در پاک کردن چت‌ها:', error);
                showNotification('خطا در پاک کردن چت‌ها', true);
            }
        }
        // تابع پاک کردن نقش‌ها
        async function clearRoles() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                const currentData = data.record || { data: { name: [], ChatShahrvand: [], gameState: {} } };
                
                // حذف نقش‌ها
                const updatedData = {
                    ...currentData,
                    data: {
                        ...currentData.data,
                        roles: {
                            spies: [],
                            citizens: []
                        }
                    }
                };
                
                // ذخیره داده‌های به‌روز شده
                await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    },
                    body: JSON.stringify(updatedData)
                });
            } catch (error) {
                console.error('خطا در پاک کردن نقش‌ها:', error);
                showNotification('خطا در پاک کردن نقش‌ها', true);
            }
        }
        // تابع پاک کردن نظرسنجی
        async function clearPoll() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                const currentData = data.record || { data: { name: [], ChatShahrvand: [], gameState: {} } };
                
                // حذف نظرسنجی
                const updatedData = {
                    ...currentData,
                    data: {
                        ...currentData.data,
                        poll: null
                    }
                };
                
                // ذخیره داده‌های به‌روز شده
                await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    },
                    body: JSON.stringify(updatedData)
                });
            } catch (error) {
                console.error('خطا در پاک کردن نظرسنجی:', error);
                showNotification('خطا در پاک کردن نظرسنجی', true);
            }
        }
        // تابع تخصیص نقش‌ها
        async function assignRoles() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                const names = data.record?.data?.name || [];
                
                // ایجاد لیست تصادفی از بازیکنان
                const shuffledNames = [...names].sort(() => Math.random() - 0.5);
                
                // انتخاب جاسوس‌ها
                spiesList = shuffledNames.slice(0, gameState.numberOfSpies);
                citizensList = shuffledNames.slice(gameState.numberOfSpies);
                
                // ذخیره نقش‌ها در دیتابیس
                await saveRolesToDatabase(spiesList, citizensList);
                
                // تعیین نقش بازیکن فعلی
                if (spiesList.includes(playerName)) {
                    playerRole = 'spy';
                } else {
                    playerRole = 'citizen';
                }
                
                // به‌روزرسانی لیست بازیکنان
                loadPlayers();
            } catch (error) {
                console.error('خطا در تخصیص نقش‌ها:', error);
                showNotification('خطا در تخصیص نقش‌ها', true);
            }
        }
        // تابع جدید برای ذخیره نقش‌ها در دیتابیس
        async function saveRolesToDatabase(spies, citizens) {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                const currentData = data.record || { data: { name: [], ChatShahrvand: [], gameState: {} } };
                
                // به‌روزرسانی داده‌ها با نقش‌ها
                const updatedData = {
                    ...currentData,
                    data: {
                        ...currentData.data,
                        roles: {
                            spies: spies,
                            citizens: citizens
                        }
                    }
                };
                
                // ذخیره داده‌های به‌روز شده
                await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    },
                    body: JSON.stringify(updatedData)
                });
            } catch (error) {
                console.error('خطا در ذخیره نقش‌ها در دیتابیس:', error);
                showNotification('خطا در ذخیره نقش‌ها در دیتابیس', true);
            }
        }
        // تابع جدید برای بارگیری نقش‌ها از دیتابیس
        async function loadRolesFromDatabase() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                    }
                });
                
                const data = await response.json();
                const roles = data.record?.data?.roles;
                
                if (roles) {
                    spiesList = roles.spies || [];
                    citizensList = roles.citizens || [];
                    
                    // تعیین نقش بازیکن فعلی
                    if (spiesList.includes(playerName)) {
                        playerRole = 'spy';
                    } else {
                        playerRole = 'citizen';
                    }
                    
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('خطا در بارگیری نقش‌ها از دیتابیس:', error);
                return false;
            }
        }
        // تابع نمایش نقش
        function showRole() {
            if (playerRole === 'spy') {
                const otherSpies = spiesList.filter(name => name !== playerName);
                roleText.innerHTML = `
                    <div>شما جاسوس هستید!</div>
                    <div class="spy-list">هم تیمی های شما: ${otherSpies.join('، ')}</div>
                `;
            } else {
                roleText.innerHTML = `
                    <div>شما شهروند هستید!</div>
                    <div>کلمه بازی: <strong>${gameState.gameWord}</strong></div>
                `;
            }
        }
        // تابع مخفی کردن نقش
        function hideRole() {
            roleText.textContent = '';
        }
        // تابع شروع چت از وضعیت ذخیره شده
        function startChatFromState() {
            // فعال کردن چت
            chatContainer.classList.remove('chat-disabled');
            chatSection.classList.remove('hidden');
            
            // شروع تایمر چت
            chatStartTime = Date.now();
            timer.classList.remove('hidden');
            
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - chatStartTime;
                const remaining = Math.max(0, 4 * 60 * 1000 - elapsed); // 4 دقیقه
                
                if (remaining === 0) {
                    clearInterval(timerInterval);
                    clearInterval(chatInterval);
                    timer.textContent = 'زمان چت به پایان رسید!';
                    chatInput.disabled = true;
                    sendMessageBtn.disabled = true;
                } else {
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    timer.textContent = `زمان باقی‌مانده چت: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                }
            }, 1000);
            
            // بارگیری چت
            loadChat();
            
            // شروع به‌روزرسانی چت
            chatInterval = setInterval(loadChat, 3000);
        }
        // تابع بارگیری چت
        async function loadChat() {
            try {
                let chatData;
                
                if (playerRole === 'spy') {
                    // بارگیری چت جاسوس‌ها
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.spyChat.binID}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': DB_CONFIG.spyChat.XmasterKey
                        }
                    });
                    chatData = await response.json();
                    displayChat(chatData.record?.data?.ChatJasoos || []);
                } else {
                    // بارگیری چت شهروندان
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                        }
                    });
                    chatData = await response.json();
                    displayChat(chatData.record?.data?.ChatShahrvand || []);
                }
            } catch (error) {
                console.error('خطا در بارگیری چت:', error);
                showNotification('خطا در بارگیری چت', true);
            }
        }
        // تابع نمایش چت
        function displayChat(messages) {
            chatMessages.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.name === playerName ? 'own' : 'other'}`;
                
                const time = new Date(msg.timestamp).toLocaleTimeString('fa-IR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageDiv.innerHTML = `
                    <div class="message-info">${msg.name} - ${time}</div>
                    <div>${msg.message}</div>
                `;
                
                chatMessages.appendChild(messageDiv);
            });
            
            // اسکرول به پایین
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        // تابع ارسال پیام
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            const newMessage = {
                name: playerName,
                message: message,
                timestamp: Date.now()
            };
            
            try {
                if (playerRole === 'spy') {
                    // ارسال به چت جاسوس‌ها
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.spyChat.binID}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': DB_CONFIG.spyChat.XmasterKey
                        }
                    });
                    
                    const data = await response.json();
                    const currentData = data.record || { data: { ChatJasoos: [] } };
                    const chatJasoos = currentData.data?.ChatJasoos || [];
                    chatJasoos.push(newMessage);
                    
                    await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.spyChat.binID}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': DB_CONFIG.spyChat.XmasterKey
                        },
                        body: JSON.stringify({
                            data: {
                                ChatJasoos: chatJasoos
                            }
                        })
                    });
                } else {
                    // ارسال به چت شهروندان
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                        }
                    });
                    
                    const data = await response.json();
                    const currentData = data.record || { data: { name: [], ChatShahrvand: [], gameState: {} } };
                    const chatShahrvand = currentData.data?.ChatShahrvand || [];
                    chatShahrvand.push(newMessage);
                    
                    await fetch(`https://api.jsonbin.io/v3/b/${DB_CONFIG.nameAndCitizenChat.binID}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': DB_CONFIG.nameAndCitizenChat.XmasterKey
                        },
                        body: JSON.stringify({
                            data: {
                                ...currentData.data,
                                ChatShahrvand: chatShahrvand
                            }
                        })
                    });
                }
                
                chatInput.value = '';
                loadChat();
            } catch (error) {
                console.error('خطا در ارسال پیام:', error);
                showNotification('خطا در ارسال پیام', true);
            }
        }
        // اگر بازیکن قبلاً نام خود را وارد کرده، فرم را مخفی کن
        if (playerName) {
            nameForm.classList.add('hidden');
            playersSection.classList.remove('hidden');
            gameStatus.classList.remove('hidden');
            
            // نمایش نام کاربر فعلی
            currentUser.textContent = playerName;
            
            // بررسی آیا بازیکن ادمین است
            isAdmin = (playerName === 'مهدی');
            if (isAdmin) {
                adminPanel.classList.remove('hidden');
            }
            
            loadPlayers();
            loadGameState();
            startGameStateCheck();
        }
    </script>
</body>
</html>
